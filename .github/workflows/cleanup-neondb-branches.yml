name: NeonDB Branch Cleanup

on:
  # Immediate cleanup: Trigger when a PR is closed (merged or not)
  pull_request:
    types: [closed]
  # Scheduled cleanup: Run daily at midnight to catch any orphaned branches
  schedule:
    - cron: '0 0 * * *'
  # Manual trigger: Allow running the workflow on demand
  workflow_dispatch:

jobs:
  cleanup-database-branches:
    name: Cleanup NeonDB Branch Databases
    runs-on: ubuntu-latest
    environment: Production

    # Required permissions
    permissions:
      contents: read    # Read repository branches
      issues: write     # Create issues on failure

    # Prevent concurrent runs to avoid race conditions
    concurrency:
      group: neondb-cleanup
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to access all branches

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Neon CLI
        run: npm install -g neonctl

      # ========================================
      # IMMEDIATE CLEANUP (on PR merge)
      # ========================================
      - name: Delete NeonDB branch for merged PR
        if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
          NEON_PROJECT_ID: ${{ secrets.NEON_PROJECT_ID }}
          BRANCH_NAME: ${{ github.head_ref }}
        run: |
          echo "============================================"
          echo "IMMEDIATE CLEANUP MODE"
          echo "PR was merged. Git branch: $BRANCH_NAME"
          echo "============================================"

          # NeonDB branches are prefixed with "preview/"
          NEON_BRANCH_NAME="preview/$BRANCH_NAME"
          echo "Looking for NeonDB branch: $NEON_BRANCH_NAME"

          # Find the NeonDB branch ID by matching the branch name
          BRANCH_ID=$(neonctl branches list \
            --project-id $NEON_PROJECT_ID \
            --api-key $NEON_API_KEY \
            -o json | jq -r ".[] | select(.name == \"$NEON_BRANCH_NAME\") | .id")

          # Exit gracefully if branch doesn't exist (may have been manually deleted)
          if [[ -z "$BRANCH_ID" ]]; then
            echo "‚ö†Ô∏è  No NeonDB branch found with name: $NEON_BRANCH_NAME"
            echo "   (Branch may have already been deleted or never existed)"
            exit 0
          fi

          # Delete the NeonDB branch
          echo "Deleting branch ID: $BRANCH_ID"
          if neonctl branches delete $BRANCH_ID \
            --project-id $NEON_PROJECT_ID \
            --api-key $NEON_API_KEY; then
            echo "‚úÖ Successfully deleted NeonDB branch: $NEON_BRANCH_NAME (ID: $BRANCH_ID)"
          else
            echo "‚ùå Failed to delete NeonDB branch: $NEON_BRANCH_NAME"
            exit 1
          fi

      # ========================================
      # SCHEDULED CLEANUP (daily at midnight)
      # ========================================
      - name: Get active Git branches
        if: github.event_name != 'pull_request'
        id: branches
        run: |
          echo "============================================"
          echo "SCHEDULED CLEANUP MODE"
          echo "Fetching active Git branches..."
          echo "============================================"

          # Get all remote branches except main/master
          BRANCHES=$(git branch -r | \
            grep -v "origin/main\|origin/master\|HEAD" | \
            sed 's|origin/||' | \
            xargs echo)

          echo "ACTIVE_BRANCHES=${BRANCHES}" >> $GITHUB_OUTPUT
          echo "Active branches: ${BRANCHES}"

      - name: Set expiration for orphaned NeonDB branches
        if: github.event_name != 'pull_request'
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
          NEON_PROJECT_ID: ${{ secrets.NEON_PROJECT_ID }}
          ACTIVE_BRANCHES: ${{ steps.branches.outputs.ACTIVE_BRANCHES }}
        run: |
          # Validate required environment variables
          if [[ -z "$NEON_API_KEY" || -z "$NEON_PROJECT_ID" ]]; then
            echo "‚ùå Error: NEON_API_KEY and NEON_PROJECT_ID must be set"
            exit 1
          fi

          # Validate jq is installed (should be pre-installed on ubuntu-latest)
          if ! command -v jq &> /dev/null; then
            echo "‚ùå Error: jq is not installed"
            exit 1
          fi

          # List all branches in the NeonDB project
          echo "Fetching all NeonDB branches..."
          NEON_BRANCHES=$(neonctl branches list \
            --project-id $NEON_PROJECT_ID \
            --api-key $NEON_API_KEY \
            -o json)

          # Process each NeonDB branch
          echo "$NEON_BRANCHES" | jq -c '.[]' | while read -r branch; do
            BRANCH_ID=$(echo $branch | jq -r '.id')
            BRANCH_NAME=$(echo $branch | jq -r '.name')

            # Skip production branches (main/master)
            if [[ "$BRANCH_NAME" == "main" || "$BRANCH_NAME" == "master" ]]; then
              echo "‚è≠Ô∏è  Skipping production branch: $BRANCH_NAME"
              continue
            fi

            # NeonDB branches are prefixed with "preview/" - strip prefix for Git comparison
            GIT_BRANCH_NAME="$BRANCH_NAME"
            if [[ "$BRANCH_NAME" == preview/* ]]; then
              GIT_BRANCH_NAME="${BRANCH_NAME#preview/}"
              echo "Checking NeonDB branch '$BRANCH_NAME' (Git branch: '$GIT_BRANCH_NAME')..."
            fi

            # Check if the corresponding Git branch still exists
            if ! echo "${ACTIVE_BRANCHES}" | grep -q "\b${GIT_BRANCH_NAME}\b"; then
              echo "üóëÔ∏è  Git branch '$GIT_BRANCH_NAME' no longer exists (NeonDB branch: '$BRANCH_NAME')"
              echo "   Setting expiration to 3 days from now..."

              # Calculate expiration date (3 days from now)
              # Supports both GNU date (Linux) and BSD date (macOS)
              EXPIRY_DATE=$(date -u -d "+3 days" "+%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || \
                           date -u -v +3d "+%Y-%m-%dT%H:%M:%SZ")

              # Set the NeonDB branch to expire
              if neonctl branches update $BRANCH_ID \
                --project-id $NEON_PROJECT_ID \
                --api-key $NEON_API_KEY \
                --expires-at $EXPIRY_DATE; then
                echo "   ‚úÖ Set expiration for '$BRANCH_NAME' to $EXPIRY_DATE"
              else
                echo "   ‚ùå Failed to set expiration for '$BRANCH_NAME'"
              fi
            else
              echo "‚úì Git branch '$GIT_BRANCH_NAME' still active (NeonDB branch: '$BRANCH_NAME' - no action needed)"
            fi
          done

          echo "============================================"
          echo "Scheduled cleanup complete!"
          echo "============================================"

      # ========================================
      # FAILURE NOTIFICATION
      # ========================================
      - name: Create GitHub issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® NeonDB cleanup workflow failed',
              body: `The NeonDB branch cleanup workflow failed.

              **Workflow Run:** [View logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              **Trigger:** ${context.eventName}
              **Branch:** ${context.ref}

              Please check the workflow logs to diagnose the issue.`
            })
